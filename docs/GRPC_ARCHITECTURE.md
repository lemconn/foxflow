# FoxFlow gRPC 架构设计

## 概述

将 FoxFlow 重构为客户端-服务端架构，通过 gRPC 进行通信。

## 架构图

```
┌─────────────────┐    gRPC     ┌─────────────────┐
│   CLI 客户端     │◄──────────►│  Engine 服务端   │
│                 │             │                 │
│ - 用户界面      │             │ - 数据库操作    │
│ - 命令解析      │             │ - 业务逻辑      │
│ - gRPC 客户端   │             │ - 策略执行      │
│ - 远程连接      │             │ - gRPC 服务端   │
└─────────────────┘             └─────────────────┘
                                        │
                                        ▼
                                ┌─────────────────┐
                                │   数据库        │
                                │                 │
                                │ - SQLite        │
                                │ - 用户数据      │
                                │ - 订单数据      │
                                │ - 策略数据      │
                                └─────────────────┘
```

## 组件说明

### CLI 客户端
- **职责**: 用户交互界面
- **功能**:
  - 命令行参数解析 (`-H`, `-P`, `-u`, `-p`)
  - 用户输入处理
  - gRPC 客户端调用
  - 结果展示和格式化

### Engine 服务端
- **职责**: 业务逻辑和数据管理
- **功能**:
  - gRPC 服务端实现
  - 数据库操作
  - 交易所 API 调用
  - 策略执行引擎
  - 订单处理

## 通信协议

### gRPC 服务定义
- **服务名**: `FoxFlowService`
- **协议**: Protocol Buffers v3
- **传输**: HTTP/2 over TCP

### 主要 RPC 方法

#### 认证管理
- `Authenticate()` - 用户认证

#### 交易所管理
- `ListExchanges()` - 列出所有交易所
- `GetExchange()` - 获取特定交易所信息

#### 账户管理
- `ListAccounts()` - 列出账户
- `CreateAccount()` - 创建账户
- `UpdateAccount()` - 更新账户
- `DeleteAccount()` - 删除账户
- `ActivateAccount()` - 激活账户

#### 订单管理
- `ListOrders()` - 列出订单
- `CreateOrder()` - 创建订单
- `OpenOrder()` - 开仓
- `CloseOrder()` - 平仓
- `CancelOrder()` - 取消订单

#### 数据查询
- `GetPositions()` - 获取持仓
- `GetBalance()` - 获取余额
- `GetNews()` - 获取新闻
- `GetSymbols()` - 获取交易对

## 命令行参数

### CLI 客户端参数
```bash
foxflow-cli [选项] [命令]

选项:
  -H string    服务端地址 (默认: 127.0.0.1)
  -P int       服务端端口 (默认: 1259)
  -u string    用户名 (默认: foxflow)
  -p string    密码 (默认: foxflow)
  -h           显示帮助信息
```

### 使用示例
```bash
# 连接本地服务端
foxflow-cli

# 连接远程服务端
foxflow-cli -H 192.168.1.100 -P 1259 -u myuser -p mypass

# 显示帮助
foxflow-cli -h
```

## 数据流

### 1. 用户认证流程
```
CLI → Authenticate() → Engine → 验证凭据 → 返回认证结果
```

### 2. 命令执行流程
```
CLI → 解析命令 → 调用对应 RPC → Engine → 数据库操作 → 返回结果 → CLI 展示
```

### 3. 策略执行流程
```
Engine → 定时检查策略 → 执行策略逻辑 → 更新订单状态 → 通知客户端
```

## 安全考虑

1. **认证机制**: 简单的用户名/密码认证
2. **连接安全**: 可选的 TLS 加密
3. **权限控制**: 基于用户的访问控制
4. **数据验证**: 服务端验证所有输入数据

## 部署方案

### 开发环境
- CLI 和 Engine 在同一台机器上运行
- 使用默认的本地连接参数

### 生产环境
- Engine 作为服务运行在服务器上
- CLI 可以部署在任意客户端机器上
- 支持多客户端同时连接

## 迁移策略

1. **保持兼容性**: 现有的 CLI 命令和交互方式不变
2. **渐进式迁移**: 先实现 gRPC 接口，再逐步替换直接调用
3. **向后兼容**: 支持本地模式和远程模式切换

## 优势

1. **远程访问**: 客户端可以从任意位置连接服务端
2. **集中管理**: 所有数据操作集中在服务端
3. **多客户端**: 支持多个客户端同时连接
4. **扩展性**: 易于添加新的功能和接口
5. **维护性**: 客户端和服务端可以独立开发和部署
